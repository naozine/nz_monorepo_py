# アンケート集計アプリ（Streamlit 単一ファイル）

目的: Excel（.xlsx）のアンケート回答データをアップロードし、インタラクティブに集計・可視化できる単一ファイルのアプリです。

## 特長/主要機能
- ファイル入力
    - .xlsx のアップロード。複数シートに対応（既定は先頭シート）。
    - 列名・件数・欠損状況の概要表示、先頭30行プレビュー（横スクロール可）。
- 集計UI（GUI）
    - 単純集計: 任意列の value_counts（個数/割合% 切替）。
    - グループ集計: 複数列でグループ化し、数値列に count/sum/mean/median/min/max を選択適用。
    - クロス集計（ピボット）: 行・列・値・集計関数、合計行列の有無を指定。値未指定時は件数。
    - 上位N抽出: カテゴリ頻度の Top-N。
    - 条件絞り込み: 複数条件（=, ≠, >, ≥, <, ≤, contains, in-list）を AND/OR 組合せ。数値/文字/日付に対応。
- プロンプト集計（自然文）
    - 日本語の自然文で集計指示（例:「性別×満足度のクロス集計を割合で」「年代別に平均スコア」「営業部のみで上位5カテゴリ」）。
    - 既定はオフラインのルールベースパーサ。OpenAI 等のLLM連携は任意（APIキー入力時のみ有効）。
    - 実行前に解釈JSONを表示・編集できる確認フロー。
- 可視化
    - 棒・横棒・折れ線・円（必要に応じて積み上げ相当の系列表示）。
    - 軸ラベル・凡例・単位（%）・ソート順を指定。上位Nで視認性担保。
- 出力
    - 集計結果を CSV/Excel ダウンロード。
    - 図を PNG ダウンロード（matplotlib）。
    - 現在の集計条件（フィルタ・グラフ設定・プロンプト解釈）を JSON でエクスポート/インポート。
- UX/操作性
    - 主要操作はサイドバー集約。メインは結果とグラフ。
    - 実行履歴（直近5件）を保持し、1クリックで復元表示（設定JSONを確認可能）。
    - 数十万行でも、不要列の除外や dtype 最適化（カテゴリ化・日付推定）を自動提案。
- バリデーション/エラーハンドリング
    - 必須列未選択、型不一致、空データなどを日本語で丁寧に案内。
    - 無効なプロンプトは「解釈案（候補）」を提示。
    - 文字化け・全角半角差・表記ゆれに対する簡易マッピングUIを搭載。
- パフォーマンス/品質
    - 読込時に dtype 推定とメモリ最適化（カテゴリ化等）。
    - 計算は pandas を使用。可視化は上位Nやサンプリングの推奨設定あり。
    - 目安として 10万行規模まで快適に操作可能。
- セキュリティ/プライバシ
    - アップロードデータは端末内で完結。外部送信なし（LLM連携はプロンプト文のみ送信、注意喚起あり）。
    - 任意コード実行の余地なし。内部APIのみを使用。

## 動作要件
- Python 3.11 以上推奨
- pip で以下をインストール（仮想環境推奨）
  ```
  pip install -r requirements.txt
  ```

## 起動方法

### テスト用Excelの生成（複数回答エクスプロードの検証用）
- サンプルデータを生成するスクリプトを用意しています。
- 様々な区切り（改行/カンマ/セミコロン/タブ/中黒/スラッシュ）や空白・重複・全角/半角・大文字/小文字などのエッジケースを含むデータを作成します。

実行例:
```
# マルチシート（各種区切りシート付き）のテストデータ
python apps/pdai/generate_explode_test_excel.py --rows 100 --seed 42 --out apps/pdai/sample_explode.xlsx

# 改行のみ区切りの専用ファイルも同時に作成
python apps/pdai/generate_explode_test_excel.py --rows 100 --seed 42 --out apps/pdai/sample_explode.xlsx \
  --newline-only-out apps/pdai/sample_explode_newline.xlsx
```
生成後、Streamlit アプリで Excel をアップロードし、サイドバーの「複数回答の縦持ち化（エクスプロード）」セクションで動作を確認してください。
- 改行のみのテストは、`sample_explode.xlsx` 内の `survey_newline` シート、または `sample_explode_newline.xlsx` の `survey` シートをご利用ください。